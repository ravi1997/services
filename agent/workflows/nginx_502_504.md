# Workflow: Nginx 502/504 Errors

**Purpose:** Diagnose and fix 502/504 gateway errors from Nginx
**When to use:** When users report 502 Bad Gateway or 504 Gateway Timeout errors
**Prerequisites:** Access to server, Nginx logs, and application logs
**Estimated time:** 15-30 minutes
**Outputs:** Fixed service, incident report

---

## Prerequisites

Before starting, verify:
- [ ] You have SSH access to the server
- [ ] You can read Nginx logs (`/var/log/nginx/`)
- [ ] You can check service status (`systemctl`, `docker ps`)
- [ ] Environment is detected (use `policy/ENV_DETECTION.md`)
- [ ] If production → follow `policy/PRODUCTION_POLICY.md` (read-only)

**If any prerequisite is not met → STOP and resolve it first.**

---

## Step 1: Collect Evidence

Run the evidence checklist to gather diagnostic information.

### Commands
```bash
# Run the checklist
cat checklists/NGINX_502_EVIDENCE.md
# Follow all commands in the checklist
```

**Must collect:**
- Nginx error logs
- Nginx access logs  
- Upstream service status
- Application logs
- Network connectivity

### If This Step Fails
- **Cannot access logs?** → Check permissions, use `sudo`
- **Logs not found?** → Verify log paths in nginx config
- **Service not found?** → Check service name in `01_PROJECT_CONTEXT.md`

---

## Step 2: Determine Failure Mode

Analyze the evidence to identify the root cause.

### Common Failure Modes

#### A) Upstream Not Running
**Symptoms:** `connect() failed (111: Connection refused)`

**Root Cause:** Application server (Gunicorn/uv icorn/etc.) is not running

**Fix:**
```bash
# Check service status
systemctl status myapp  # or docker ps

# If stopped, start it
systemctl start myapp  # or docker-compose up -d
```

---

#### B) Port/Socket Mismatch
**Symptoms:** `connect() failed (111: Connection refused)` but service is running

**Root Cause:** Nginx upstream points to wrong port/socket

**Fix:**
```bash
# Check what port app is listening on
ss -tlnp | grep python  # or netstat -tlnp

# Check nginx upstream config
grep -r "upstream" /etc/nginx/

# Update nginx config if mismatch
# Example: change proxy_pass http://127.0.0.1:8000 to correct port
```

---

#### C) Connection Timeout
**Symptoms:** `upstream timed out (110: Connection timed out)`

**Root Cause:** Network issue or firewall blocking connection

**Fix:**
```bash
# Test connectivity
curl -I http://localhost:8000/healthz

# Check firewall
sudo iptables -L | grep 8000

# If firewall blocking, add rule (dev/staging only)
```

---

#### D) Read Timeout
**Symptoms:** `upstream timed out (110: Connection timed out)` after connection established

**Root Cause:** Request takes too long, timeout mismatch

**Fix:**
```bash
# Check current timeouts in nginx
grep timeout /etc/nginx/nginx.conf
grep timeout /etc/nginx/sites-available/myapp

# If justified, increase timeout (carefully)
# proxy_read_timeout 60s; → 90s;
```

---

#### E) Application Crash
**Symptoms:** `502` with application errors in logs

**Root Cause:** App crashed due to import error, missing dependency, config issue

**Fix:**
```bash
# Check application logs
journalctl -u myapp -n 50
# or
docker logs myapp --tail 50

# Look for:
# - ImportError
# - ModuleNotFoundError  
# - Configuration errors
# - Missing environment variables

# Fix the error (install deps, fix config, etc.)
```

---

## Step 3: Apply the Fix

Based on the failure mode identified, apply the smallest safe fix.

### For Dev/Staging
```bash
# 1. Make the fix (examples above)

# 2. Test nginx config
sudo nginx -t

# 3. Reload nginx
sudo systemctl reload nginx

# 4. Restart app if needed
sudo systemctl restart myapp
# or
docker-compose restart web
```

### For Production
**DO NOT execute commands directly.**

Provide commands for user to run:
```markdown
I've identified the issue: [ISSUE]

Please run these commands:
1. Test nginx config:
   sudo nginx -t

2. Reload nginx:
   sudo systemctl reload nginx

3. Verify:
   curl -I https://yoursite.com
```

---

## Step 4: Verify the Fix

Confirm the issue is resolved.

### Verification Commands
```bash
# 1. Check nginx status
sudo systemctl status nginx
# Expected: active (running)

# 2. Check upstream service
sudo systemctl status myapp
# Expected: active (running)

# 3. Test endpoint
curl -I http://localhost/healthz
# Expected: HTTP/1.1 200 OK

# 4. Check for new errors
sudo tail -f /var/log/nginx/error.log
# Expected: No new 502/504 errors

# 5. Monitor for 2-3 minutes
# Expected: No errors, requests succeeding
```

### If Verification Fails
- **Still getting 502?** → Re-run Step 1 (collect fresh evidence)
- **Different error?** → New issue, start over
- **Intermittent?** → May be load-related, check `workflows/performance_profiling.md`

---

## Completion Criteria

This workflow is complete when:
- ✅ No more 502/504 errors occurring
- ✅ Health check returns 200 OK
- ✅ Application logs show no errors
- ✅ Nginx error log shows no upstream failures
- ✅ Monitored for 2-3 minutes with no issues
- ✅ Incident report created (if production)

**Do NOT mark complete until all criteria are met.**

---

## Rollback Plan

If the fix causes new issues:

```bash
# 1. Revert nginx config
sudo cp /etc/nginx/sites-available/myapp.backup /etc/nginx/sites-available/myapp
sudo nginx -t
sudo systemctl reload nginx

# 2. Restart service to previous state
sudo systemctl restart myapp

# 3. Verify rollback
curl -I http://localhost/healthz
```

---

## Required Artifacts

### For Production Incidents
- **Always:** `artifacts/incident_report.md`
- **If config changed:** `artifacts/DECISION_RECORD.md`
- **If major outage:** `artifacts/postmortem.md`

### For Dev/Staging
- **If code/config changed:** `artifacts/pr_summary.md`

---

## Common Mistakes to Avoid

❌ **Don't** restart nginx without testing config (`nginx -t`)
❌ **Don't** increase timeouts without understanding why requests are slow
❌ **Don't** assume the issue - always collect evidence first
❌ **Don't** make multiple changes at once - fix one thing at a time
❌ **Don't** skip verification - always confirm the fix works

---

## Troubleshooting

### Issue: Can't find nginx config
```bash
# Find nginx config
nginx -t 2>&1 | grep "configuration file"

# Find site configs
ls -la /etc/nginx/sites-available/
ls -la /etc/nginx/sites-enabled/
```

### Issue: Don't know upstream service name
```bash
# Check PROJECT_CONTEXT
cat agent/01_PROJECT_CONTEXT.md | grep service

# Or check docker-compose
cat docker-compose.yml | grep -A 5 "services:"
```

### Issue: Logs are huge
```bash
# Get last 100 lines only
tail -n 100 /var/log/nginx/error.log

# Filter for 502/504
grep -E "502|504" /var/log/nginx/error.log | tail -n 50
```

---

## See Also

- [`../checklists/NGINX_502_EVIDENCE.md`](../checklists/NGINX_502_EVIDENCE.md) - Evidence collection
- [`../skills/nginx_gunicorn.md`](../skills/nginx_gunicorn.md) - Nginx/Gunicorn debugging
- [`../policy/PRODUCTION_POLICY.md`](../policy/PRODUCTION_POLICY.md) - Production safety
- [`../workflows/systemd_failures.md`](systemd_failures.md) - If service won't start
- [`../workflows/performance_profiling.md`](performance_profiling.md) - If timeout related
